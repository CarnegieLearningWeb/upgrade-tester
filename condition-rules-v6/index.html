<!DOCTYPE html>
<html lang="en-US">

<head>
    <title>UpGrade Tester v6.0.13 - Condition Rules</title>
    <meta charset=utf-8 />
    <meta name="description" content="UpGrade Tester" />
    <meta name="keywords" content="UpGrade, Tester" />
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, minimum-scale=0.6, maximum-scale=0.6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800&amp;lang=en" />
    <link rel="icon" type="image/x-icon" href="/assets/favicons/favicon.ico" />
    <style>
        /* ==================== universal ==================== */

        * {
            padding: 0;
            margin: 0;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }

        html,
        body {
            font-family: 'Open Sans', sans-serif;
            width: 100%;
            height: 100%;
            font-size: 16px;
            background: #F0F2F8;
        }

        button,
        select,
        input {
            border-radius: 5px;
            font-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        button {
            border: none;
            font-weight: 600;
            color: #FFFFFF;
            cursor: pointer;
        }

        button:focus {
            outline: none;
            box-shadow: none;
        }

        i {
            margin-right: 10px;
        }

        label {
            font-size: 16px;
            font-weight: 700;
            color: #444444;
        }

        select,
        input {
            text-indent: 10px;
            border: 1px solid #808080;
            font-weight: 400;
            color: #444444;
            box-shadow: none;
        }

        select {
            background: url("/assets/images/down-icon.png");
            background-repeat: no-repeat;
            background-position: right;
            background-size: 20px;
        }

        select:focus,
        input:focus {
            outline: 0;
            border-color: rgb(163, 197, 255);
            border: 1px solid rgb(163, 197, 255);
            -webkit-box-shadow: 0 0 5px rgb(163, 197, 255);
            -moz-box-shadow: 0 0 5px rgb(163, 197, 255);
            box-shadow: 0 0 5px rgb(163, 197, 255);
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            font-size: 16px;
            text-align: center;
            color: #444444;
        }

        table tr th,
        table tr td {
            width: 120px;
            height: 60px;
            border-right: 1px solid #808080;
            border-bottom: 1px solid #808080;
        }

        table tr th:first-child,
        table tr td:first-child {
            font-weight: bold;
            background: #F0F2F8;
            border-left: 1px solid #808080;
        }

        table tr th {
            font-weight: bold;
            background: #F0F2F8;
            border-top: solid 1px #808080;
        }

        table tr:first-child th:first-child {
            border-top-left-radius: 5px;
        }

        table tr:first-child th:last-child {
            border-top-right-radius: 5px;
        }

        table tr:last-child td:first-child {
            border-bottom-left-radius: 5px;
        }

        table tr:last-child td:last-child {
            border-bottom-right-radius: 5px;
        }

        .shadowed {
            -webkit-box-shadow: 1px 2px 2px rgba(0, 0, 0, 0.25);
            -moz-box-shadow: 1px 2px 2px rgba(0, 0, 0, 0.25);
            box-shadow: 1px 2px 2px rgba(0, 0, 0, 0.25);
        }

        .unselectable {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .recolor-444444 {
            -webkit-filter: invert(22%) sepia(0%) saturate(2%) hue-rotate(243deg) brightness(104%) contrast(87%);
            filter: invert(22%) sepia(0%) saturate(2%) hue-rotate(243deg) brightness(104%) contrast(87%);
        }

        /* ==================== wrapper ==================== */

        #wrapper {
            width: 100%;
            min-width: 500px;
            height: 100%;
            min-height: 700px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        /* ==================== header ==================== */

        #header {
            width: 100%;
            height: 88px;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            background: #FFFFFF;
            padding: 0 30px;
        }

        #title {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }

        #upgrade-logo {
            width: 28px;
            height: 27px;
        }

        #title-text {
            margin-left: 10px;
            font-size: 28px;
            font-weight: 800;
            color: #3F68F6;
        }

        #subtitle-text {
            margin-top: 12px;
            margin-left: 10px;
            font-size: 12px;
            font-weight: 600;
            color: #3F68F6;
        }

        /* ==================== main ==================== */

        #main {
            margin-top: 6px;
            width: calc(100% - 12px);
            height: calc(100% - 88px - 12px);
            display: flex;
            flex-direction: row;
            gap: 6px;
            justify-content: flex-start;
            align-items: flex-start;
        }

        /* ==================== card-wrapper ==================== */

        .card-wrapper {
            width: 100%;
            height: 100%;
            border-radius: 5px;
            background: #FFFFFF;
        }

        /* ==================== card-header ==================== */

        .card-header {
            width: 100%;
            height: 60px;
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
            border-bottom: solid 1px #B7B9BC;
        }

        .card-title {
            width: 100%;
            height: calc(100% - 3px);
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }

        .card-icon {
            width: 23px;
            height: 23px;
        }

        #upgrade-icon {
            margin-right: -4px;
            margin-top: 4px;
            width: 26px;
            height: 29px;
        }

        .card-text {
            margin-left: 10px;
            font-size: 16px;
            font-weight: 600;
            color: #444444;
        }

        /* ==================== card-content ==================== */

        .card-content {
            width: 100%;
            height: calc(100% - 60px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* ==================== experiment-settings-form ==================== */

        #experiment-settings-form {
            width: 450px;
            row-gap: 32px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        #selects-container {
            width: 100%;
            row-gap: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .select-wrapper {
            width: 100%;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        .select {
            width: 250px;
            height: 35px;
            background-position-x: calc(250px - 30px);
        }

        #button-wrapper {
            width: 450px;
            height: 48px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #runtest-button {
            width: 100%;
            height: 100%;
            background: #3F68F6;
            opacity: 1;
            -webkit-transition: opacity 0.25s;
            -moz-transition: opacity 0.25s;
            transition: opacity 0.25s;
            cursor: pointer;
        }

        #runtest-button:hover {
            background: #325BE9;
        }

        #runtest-button:active {
            background: #264FDD;
        }

        #runtest-button:disabled {
            background: #3F68F6;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* ==================== tables ==================== */

        #conditions-table {
            width: calc(120px * 4);
            height: calc(60px * 6);
            table-layout: fixed;
        }

        #response-time-table {
            margin-top: 30px;
            width: calc(120px * 4);
            height: calc(60px * 2);
            table-layout: fixed;
        }

        #split-cell {
            background-image: linear-gradient(to bottom left, #F0F2F8 49%, #808080 50%, #F0F2F8 51%);
        }

        th #split-topright {
            -webkit-transform: translate(10px, -10px);
            -ms-transform: translate(10px, -10px);
            transform: translate(28px, -5px);
        }

        th #split-bottomleft {
            -webkit-transform: translate(-10px, 10px);
            -ms-transform: translate(-10px, 10px);
            transform: translate(-20px, 5px);
        }

        /* ==================== table loading ==================== */

        #table-overlay {
            position: absolute;
            width: calc(50% - 6px);
            height: calc(100% - 88px - 12px - 60px);
            background: rgba(255, 255, 255, 0.35);
            border-radius: 5px;
            opacity: 0;
            -webkit-transition: opacity 0.25s;
            -moz-transition: opacity 0.25s;
            transition: opacity 0.25s;
            pointer-events: none;
        }

        #loading-spinner {
            position: absolute;
            animation: loading 1s linear infinite;
            border: solid 7px transparent;
            border-top: solid 7px #90EAD8;
            border-bottom: solid 7px #90EAD8;
            border-radius: 50px;
            width: 100px;
            height: 100px;
            opacity: 0;
            -webkit-transition: opacity 0.25s;
            -moz-transition: opacity 0.25s;
            transition: opacity 0.25s;
            pointer-events: none;
        }

        @keyframes loading {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ==================== bottom-gap ==================== */

        #bottom-gap {
            display: none;
            width: 100%;
            height: 2px;
        }

        @media screen and (max-width: calc(500px * 2 + 6px * 3)) {
            #main {
                flex-wrap: wrap;
            }

            #bottom-gap {
                display: inline-block;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/smoothscroll-polyfill@0.4.4/dist/smoothscroll.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upgrade_client_lib@6.0.13/dist/browser/index.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <div id="g_id_onload"
        data-client_id="656936260684-hdsihcgcdrcbeom72n56o8n5rb2mtc58.apps.googleusercontent.com"
        data-callback="handleCredentialResponse">
    </div>
</head>

<body>
    <div id="wrapper">
        <div id="header" class="shadowed">
            <div id="title">
                <img id="upgrade-logo" src="/assets/images/upgrade-logo.png" alt="UpGrade Logo">
                <h2 id="title-text">UpGrade Tester</h2>
                <h4 id="subtitle-text">v6.0.13 - Condition Rules</h4>
            </div>
            <div class="g_id_signin" data-type="standard"></div>
        </div>
        <div id="main">
            <div class="card-wrapper shadowed">
                <div class="card-header">
                    <div class="card-title">
                        <img class="card-icon recolor-444444" id="upgrade-icon" src="/assets/images/upgrade-icon.png" alt="UpGrade Icon">
                        <h4 class="card-text">Experiment Settings</h4>
                    </div>
                </div>
                <div class="card-content">
                    <form id="experiment-settings-form">
                        <div id="selects-container">
                            <div class="select-wrapper">
                                <label for="host-url">UpGrade Host URL:</label>
                                <select name="host-url" class="select" id="host-url">
                                    <option value="https://apps.qa-cli.net/upgrade-service" selected>https://apps.qa-cli.net</option>
                                    <option value="https://apps.qa-cli.com/upgrade-service">https://apps.qa-cli.com</option>
                                    <option value="http://localhost:3030">http://localhost:3030</option>
                                </select>
                            </div>
                            <div class="select-wrapper">
                                <label for="app-context">App Context:</label>
                                <select name="app-context" class="select" id="app-context">
                                </select>
                            </div>
                            <div class="select-wrapper">
                                <label for="unit-of-assignment">Unit of Assignment:</label>
                                <select name="unit-of-assignment" class="select" id="unit-of-assignment">
                                    <option value="Individual" selected>Individual</option>
                                </select>
                            </div>
                            <div class="select-wrapper">
                                <label for="consistency-rule">Consistency Rule:</label>
                                <select name="consistency-rule" class="select" id="consistency-rule">
                                    <option value="Individual" selected>Individual</option>
                                </select>
                            </div>
                            <div class="select-wrapper">
                                <label for="experiment-type">Experiment Type:</label>
                                <select name="experiment-type" class="select" id="experiment-type">
                                    <option value="Simple" selected>Simple Experiment</option>
                                    <option value="Factorial">Factorial Experiment</option>
                                </select>
                            </div>
                            <div class="select-wrapper">
                                <label for="post-experiment-rule">Post Experiment Rule:</label>
                                <select name="post-experiment-rule" class="select" id="post-experiment-rule">
                                    <option value="Continue" selected>Continue</option>
                                    <option value="Default">Default</option>
                                    <option value="Condition A">Condition A</option>
                                    <option value="Condition B">Condition B</option>
                                    <option value="Condition C">Condition C</option>
                                </select>
                            </div>
                            <div class="select-wrapper">
                                <label for="exclude-if-reached">Exclude If Reached:</label>
                                <select name="exclude-if-reached" class="select" id="exclude-if-reached">
                                    <option value="True" selected>True</option>
                                    <option value="False">False</option>
                                </select>
                            </div>
                            <div class="select-wrapper">
                                <label for="status-update-delay">Status Update Delay (s):</label>
                                <input type="number" name="status-update-delay" class="select" id="status-update-delay" min="0" max="30" value="0">
                            </div>
                        </div>
                        <div id="button-wrapper">
                            <button id="runtest-button" class="unselectable" type="submit" disabled><i class="fa fa-rocket fa-lg"></i>Run Test</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card-wrapper shadowed">
                <div class="card-header">
                    <div class="card-title">
                        <img class="card-icon recolor-444444" id="admin-tool-icon" src="/assets/images/admin-tool-icon.png" alt="Admin Tool Icon">
                        <h4 class="card-text">Test Results</h4>
                    </div>
                </div>
                <div class="card-content">
                    <table id="conditions-table">
                        <tr>
                            <th id="split-cell">
                                <div id="split-topright">Status</div>
                                <div id="split-bottomleft">Student</div>
                            </th>
                            <th>Inactive</th>
                            <th>Enrolling</th>
                            <th>Complete</th>
                        </tr>
                        <tr>
                            <td class="student-cell">Student 1 (Individual)</td>
                            <td class="condition-cell"></td>
                            <td class="condition-cell"></td>
                            <td class="condition-cell"></td>
                        </tr>
                        <tr>
                            <td class="student-cell">Student 2 (Individual)</td>
                            <td class="condition-cell"></td>
                            <td class="condition-cell"></td>
                            <td class="condition-cell"></td>
                        </tr>
                        <tr>
                            <td class="student-cell">Student 3 (Individual)</td>
                            <td class="condition-cell"></td>
                            <td class="condition-cell"></td>
                            <td class="condition-cell"></td>
                        </tr>
                        <tr>
                            <td class="student-cell">Student 4 (Individual)</td>
                            <td class="condition-cell"></td>
                            <td class="condition-cell"></td>
                            <td class="condition-cell"></td>
                        </tr>
                        <tr>
                            <td class="student-cell">Student 5 (Individual)</td>
                            <td class="condition-cell"></td>
                            <td class="condition-cell"></td>
                            <td class="condition-cell"></td>
                        </tr>
                    </table>
                    <table id="response-time-table">
                        <tr>
                            <th id="split-cell">
                                <div id="split-topright">API</div>
                                <div id="split-bottomleft">Measure</div>
                            </th>
                            <th>Init</th>
                            <th>Assign</th>
                            <th>Mark</th>
                        </tr>
                        <tr>
                            <td class="measure-cell">Response Time (ms)</td>
                            <td class="response-time-cell"></td>
                            <td class="response-time-cell"></td>
                            <td class="response-time-cell"></td>
                        </tr>
                    </table>
                    <div id="table-overlay"></div>
                    <div id="loading-spinner"></div>
                </div>
            </div>
            <div id="bottom-gap"></div>
        </div>
    </div>

    <script>
        (function() {
            let token = null;

            // Handle successful login
            window.handleCredentialResponse = async (response) => {
                // Retrieve token
                token = response.credential;
                const signInButton = document.querySelector(".g_id_signin");

                // Hide the sign-in button
                signInButton.style.display = "none";

                // Initialize UpGrade Tester
                const runTestButton = document.getElementById("runtest-button");
                const conditionsTable = document.getElementById("conditions-table");
                const responseTimeTable = document.getElementById("response-time-table");
                const experimentSettings = {
                    experimentSettingsForm: document.getElementById("experiment-settings-form"),
                    hostUrlSelect: document.getElementById("host-url"),
                    appContextSelect: document.getElementById("app-context"),
                    assignmentUnitSelect: document.getElementById("unit-of-assignment"),
                    consistencyRuleSelect: document.getElementById("consistency-rule"),
                    experimentTypeSelect: document.getElementById("experiment-type"),
                    postExperimentRuleSelect: document.getElementById("post-experiment-rule"),
                    excludeIfReachedSelect: document.getElementById("exclude-if-reached"),
                    statusUpdateDelay: document.getElementById("status-update-delay"),
                    runTestButton,
                    conditionsTable,
                    studentCells: conditionsTable.getElementsByClassName("student-cell"),
                    conditionCells: conditionsTable.getElementsByClassName("condition-cell"),
                    responseTimeTable,
                    responseTimeCells: responseTimeTable.getElementsByClassName("response-time-cell"),
                    tableOverlay: document.getElementById("table-overlay"),
                    loadingSpinner: document.getElementById("loading-spinner"),
                };
                try {
                    const tester = new UpGradeTester(experimentSettings);
                    await tester.init();
                } catch (error) {
                    this.logError(error);
                }

                // Log out automatically after 1 hour
                setTimeout(() => {
                    // Clear token
                    token = null;

                    // Disable the Run Test button
                    runTestButton.disabled = true;

                    // Show the sign-in button
                    signInButton.style.display = "block";
                }, 3600000);
            };

            class UpGradeTester {
                constructor(experimentSettings) {
                    this.experimentSettingsForm = experimentSettings.experimentSettingsForm;
                    this.hostUrlSelect = experimentSettings.hostUrlSelect;
                    this.appContextSelect = experimentSettings.appContextSelect;
                    this.assignmentUnitSelect = experimentSettings.assignmentUnitSelect;
                    this.consistencyRuleSelect = experimentSettings.consistencyRuleSelect;
                    this.experimentTypeSelect = experimentSettings.experimentTypeSelect;
                    this.postExperimentRuleSelect = experimentSettings.postExperimentRuleSelect;
                    this.excludeIfReachedSelect = experimentSettings.excludeIfReachedSelect;
                    this.statusUpdateDelay = experimentSettings.statusUpdateDelay;
                    this.runTestButton = experimentSettings.runTestButton;
                    this.conditionsTable = experimentSettings.conditionsTable;
                    this.studentCells = experimentSettings.studentCells;
                    this.conditionCells = experimentSettings.conditionCells;
                    this.responseTimeTable = experimentSettings.responseTimeTable;
                    this.responseTimeCells = experimentSettings.responseTimeCells;
                    this.tableOverlay = experimentSettings.tableOverlay;
                    this.loadingSpinner = experimentSettings.loadingSpinner;
                    this.queryKeys = [];
                    this.conditionCodes = [];
                    this.appContextGroupTypesMap = {};
                    this.isLoading = false;
                    this.conditionCellColorMap = {
                        "Default": "rgb(235, 255, 235)",
                        "Condition A": "rgb(255, 225, 225)",
                        "Condition B": "rgb(255, 255, 225)",
                        "Condition C": "rgb(245, 235, 255)",
                        "factorA=A1; factorB=B1": "rgb(255, 225, 225)",
                        "factorA=A2; factorB=B1": "rgb(255, 255, 225)",
                        "factorA=A1; factorB=B2": "rgb(245, 235, 255)",
                        "factorA=A2; factorB=B2": "rgb(225, 235, 255)"
                    };
                    this.responseTimeCellColorMap = {
                        "Fast": "rgb(235, 255, 235)",
                        "Moderate": "rgb(255, 255, 225)",
                        "Slow": "rgb(255, 225, 225)"
                    };
                    this.minModerateTime = 250;
                    this.minSlowTime = 500;
                    this.conditionCellMap = {};
                    for (let i = 0; i < this.conditionCells.length; i += 3) {
                        this.conditionCellMap[`student${Math.floor(i / 3) + 1}`] = {
                            inactive: this.conditionCells[i],
                            enrolling: this.conditionCells[i + 1],
                            enrollmentComplete: this.conditionCells[i + 2]
                        };
                    }
                    this.responseTimeCellMap = {
                        init: {},
                        assign: {},
                        mark: {}
                    };
                    Object.values(this.responseTimeCellMap).forEach((value, index) => {
                        value.cell = this.responseTimeCells[index];
                        value.responseTimes = [];
                    });
                    this.date = "";
                    this.experimentId = "";
                    this.experimentStatus = "";
                    this.fetchWrapper = new FetchWrapper();
                    this.idGenerator = new IdGenerator();

                    // Bind the listeners
                    this.hostUrlSelect.onchange = this.onHostUrlSelectChange.bind(this);
                    this.appContextSelect.onchange = this.onAppContextSelectChange.bind(this);
                    this.assignmentUnitSelect.onchange = this.onAssignmentUnitSelectChange.bind(this);
                    this.experimentTypeSelect.onchange = this.onExperimentTypeSelectChange.bind(this);
                    this.experimentSettingsForm.onsubmit = this.onExperimentSettingsFormSubmit.bind(this);

                    // Initialize states
                    this.onExperimentTypeSelectChange();
                }

                async init() {
                    this.runTestButton.disabled = true;
                    await this.setAppContextSelectOptions();
                    this.runTestButton.disabled = false;
                }

                async setAppContextSelectOptions() {
                    this.appContextSelect.options.length = 0;
                    this.appContextGroupTypesMap = {};
                    const { contextMetadata } = await this.fetchWrapper.get(`${this.hostUrlSelect.value}/api/experiments/contextMetadata`);
                    for (const appContext of Object.keys(contextMetadata)) {
                        const option = document.createElement("option");
                        option.text = appContext;
                        option.value = appContext;
                        this.appContextSelect.add(option);
                        this.appContextGroupTypesMap[appContext] = contextMetadata[appContext].GROUP_TYPES;
                    }
                    if (this.appContextSelect.options.length) {
                        this.appContextSelect.options[0].selected = true;
                        this.onAppContextSelectChange();
                    }
                }

                async onHostUrlSelectChange() {
                    try {
                        await this.init();
                    } catch (error) {
                        this.logError(error);
                    }
                }

                onAppContextSelectChange() {
                    this.assignmentUnitSelect.options.length = 1; // Keep only the first option (Individual)
                    const groupTypes = this.appContextGroupTypesMap[this.appContextSelect.value];
                    for (const groupType of groupTypes) {
                        const option = document.createElement("option");
                        option.text = `Group (${groupType})`;
                        option.value = groupType; // The actual group type is stored as a value
                        this.assignmentUnitSelect.add(option);
                    }
                    this.onAssignmentUnitSelectChange();
                }

                onAssignmentUnitSelectChange() {
                    if (this.assignmentUnitSelect.value === "Individual") {
                        this.consistencyRuleSelect.innerHTML = `
                            <option value="Individual" selected>Individual</option>`;
                    } else {
                        const prevValue = this.consistencyRuleSelect.value;
                        this.consistencyRuleSelect.innerHTML = `
                            <option value="Individual">Individual</option>
                            <option value="Group">Group</option>`;
                        this.consistencyRuleSelect.value = prevValue;
                    }
                    for (let i = 0; i < this.studentCells.length; i++) {
                        this.studentCells[i].innerText = `Student ${i + 1} (${this.assignmentUnitSelect.value === "Individual" ? "Individual" : `Group ${i < 3 ? "A" : "B"}`})`;
                    }
                }

                onExperimentTypeSelectChange() {
                    if (this.experimentTypeSelect.value === "Simple") {
                        this.postExperimentRuleSelect.innerHTML = `
                        <option value="Continue" selected>Continue</option>
                        <option value="Default">Default</option>
                        <option value="Condition A">Condition A</option>
                        <option value="Condition B">Condition B</option>
                        <option value="Condition C">Condition C</option>`;
                        this.conditionCodes = ["Condition A", "Condition B", "Condition C"];
                    } else if (this.experimentTypeSelect.value === "Factorial") {
                        this.postExperimentRuleSelect.innerHTML = `
                        <option value="Continue" selected>Continue</option>
                        <option value="Default">Default</option>
                        <option value="factorA=A1; factorB=B1">factorA=A1; factorB=B1</option>
                        <option value="factorA=A2; factorB=B1">factorA=A2; factorB=B1</option>
                        <option value="factorA=A1; factorB=B2">factorA=A1; factorB=B2</option>
                        <option value="factorA=A2; factorB=B2">factorA=A2; factorB=B2</option>`;
                        this.conditionCodes = ["factorA=A1; factorB=B1", "factorA=A2; factorB=B1", "factorA=A1; factorB=B2", "factorA=A2; factorB=B2"];
                    }
                }

                async onExperimentSettingsFormSubmit(event) {
                    event.preventDefault();
                    try {
                        if (this.isLoading) {
                            return;
                        }
                        // Enable loading
                        this.setLoadingState(true);

                        // Scroll to the bottom of the page
                        if (document.body.scrollHeight > window.innerHeight) {
                            window.scrollTo({
                                top: document.body.scrollHeight / 2,
                                behavior: "smooth"
                            });
                        }

                        // Create experiment
                        await this.createExperiment();

                        // Perform test
                        await this.performTest();

                        // Delete the experiment
                        await this.deleteExperiment();

                        // Disable loading
                        this.setLoadingState(false);
                    } catch (error) {
                        // Disable loading
                        this.setLoadingState(false);

                        // Scroll to the top of the page
                        window.scrollTo({
                            top: 0,
                            behavior: "smooth"
                        });

                        // Print and alert error
                        this.logError(error);
                    }
                }

                logError(error) {
                    console.error(error);
                    if (error.message === "Failed to fetch") {
                        alert(`Failed to access the UpGrade host URL: ${this.hostUrlSelect.value}.\nPlease make sure UpGrade is running on ${this.hostUrlSelect.value}.`);
                        return;
                    }
                    alert(error);
                }

                setLoadingState(state) {
                    this.isLoading = state;
                    this.runTestButton.style.pointerEvents = state ? "none" : "auto";
                    this.runTestButton.style.opacity = state ? 0.7 : 1;
                    this.tableOverlay.style.opacity = state ? 1 : 0;
                    this.loadingSpinner.style.opacity = state ? 1 : 0;
                }

                async deleteExperiment() {
                    await this.fetchWrapper.delete(`${this.hostUrlSelect.value}/api/experiments/${this.experimentId}`);
                }

                async deleteAllExperiments() {
                    const experiments = await this.fetchWrapper.get(`${this.hostUrlSelect.value}/api/experiments`);
                    for (const experiment of experiments) {
                        await this.deleteExperiment(experiment.id);
                    }
                }

                async saveMetrics() {
                    await this.fetchWrapper.post(`${this.hostUrlSelect.value}/api/metric/save`, {
                        metricUnit: [{
                                metric: "durationSeconds",
                                datatype: "continuous"
                            },
                            {
                                metric: "percentCorrect",
                                datatype: "continuous"
                            }
                        ]
                    });
                }

                async getVersion() {
                    const info = await this.fetchWrapper.get(`${this.hostUrlSelect.value}/api`);
                    const parts = info.version.split(".");
                    return {
                        full: info.version,
                        major: parseInt(parts[0], 10),
                        minor: parts[1] ? parseInt(parts[1], 10) : 0,
                        bugfix: parts[2] ? parseInt(parts[2], 10) : 0
                    };
                }

                async createExperiment() {
                    const version = await this.getVersion();
                    const backendVersion = version.full;
                    console.log("UpGrade Backend Version:", backendVersion);
                    const useReference = version.major > 5 || (version.major === 5 && version.minor >= 2); // Note: https://github.com/CarnegieLearningWeb/UpGrade/pull/1379
                    this.date = new Date().toISOString();
                    this.idGenerator.reset();
                    this.experimentId = this.idGenerator.uuidv4();
                    this.experimentStatus = "inactive";
                    const conditionIdMap = {};
                    const payloadIdMap = {};
                    const levelCombinationIdMap = {};
                    const levelIdMap = {};
                    for (const conditionCode of this.conditionCodes) {
                        conditionIdMap[conditionCode] = {
                            id: this.idGenerator.uuidv4(),
                            twoCharacterId: this.idGenerator.twoCharacterId()
                        }
                        payloadIdMap[conditionCode] = this.idGenerator.uuidv4();
                        if (this.experimentTypeSelect.value !== "Factorial") {
                            continue;
                        }
                        levelCombinationIdMap[conditionCode] = conditionCode.split("; ").map(conditionCode => {
                            const levelName = conditionCode.split("=")[1];
                            if (!(levelName in levelIdMap)) {
                                levelIdMap[levelName] = this.idGenerator.uuidv4();
                            }
                            return {
                                id: this.idGenerator.uuidv4(),
                                levelId: levelIdMap[levelName],
                                levelName: levelName
                            }
                        });
                    }
                    const decisionPoint = { // Note: Currently, only one decision point is used
                        id: this.idGenerator.uuidv4(),
                        twoCharacterId: this.idGenerator.twoCharacterId(),
                        site: `Site_${this.experimentId}`,
                        target: `Target_${this.experimentId}`
                    };
                    const segmentNamePrefix = this.idGenerator.uuidv4();
                    const postExperimentRule = this.postExperimentRuleSelect.value === "Continue" ? "continue" : "assign";
                    const postExperimentConditionCode = this.postExperimentRuleSelect.value === "Continue" ? null : this.postExperimentRuleSelect.value;
                    const experimentData = {
                        createdAt: this.date,
                        updatedAt: this.date,
                        versionNumber: 1,
                        id: this.experimentId,
                        name: `Experiment_${this.experimentId}`,
                        description: "",
                        context: [this.appContextSelect.value],
                        state: "inactive",
                        startOn: null,
                        consistencyRule: this.consistencyRuleSelect.value.toLowerCase(),
                        assignmentUnit: this.assignmentUnitSelect.value === "Individual" ? "individual" : "group",
                        postExperimentRule,
                        enrollmentCompleteCondition: null,
                        endOn: null,
                        revertTo: postExperimentRule === "assign" ? conditionIdMap.hasOwnProperty(postExperimentConditionCode) ? conditionIdMap[postExperimentConditionCode].id : null : null,
                        tags: [],
                        group: this.assignmentUnitSelect.value === "Individual" ? null : this.assignmentUnitSelect.value,
                        conditionOrder: null,
                        assignmentAlgorithm: "random",
                        logging: false,
                        filterMode: "includeAll",
                        backendVersion,
                        type: this.experimentTypeSelect.value,
                        partitions: [this.makePartition(decisionPoint)],
                        conditions: this.conditionCodes.map(conditionCode => this.makeCondition(conditionCode, conditionIdMap, payloadIdMap, levelCombinationIdMap, false)),
                        stateTimeLogs: [],
                        queries: this.makeQueries(),
                        experimentSegmentInclusion: this.makeExperimentSegment(segmentNamePrefix, "Inclusion"),
                        experimentSegmentExclusion: this.makeExperimentSegment(segmentNamePrefix, "Exclusion"),
                        factors: this.experimentTypeSelect.value !== "Factorial" ? [] : this.makeFactors(this.conditionCodes, levelIdMap),
                        stratificationFactor: null,
                        conditionPayloads: this.makePayloads(decisionPoint, conditionIdMap, payloadIdMap, levelCombinationIdMap, useReference)
                    }
                    // console.log("experimentData:", JSON.stringify(experimentData, null, 2));
                    await this.fetchWrapper.post(`${this.hostUrlSelect.value}/api/experiments`, experimentData);
                }

                async performTest() {
                    // Empty the condition cells
                    for (const conditionCell of this.conditionCells) {
                        conditionCell.innerText = "";
                        conditionCell.style.background = "#FFFFFF";
                    }
                    // Empty the response time cells
                    Object.values(this.responseTimeCellMap).forEach((value) => {
                        value.cell.innerText = "";
                        value.cell.style.background = "#FFFFFF";
                        value.responseTimes = [];
                    });
                    // Create students
                    const makeStudent = (studentName) => {
                        return {
                            name: studentName,
                            id: this.idGenerator.uuidv4()
                        };
                    }
                    const student1 = makeStudent("student1");
                    const student2 = makeStudent("student2");
                    const student3 = makeStudent("student3");
                    const student4 = makeStudent("student4");
                    const student5 = makeStudent("student5");
                    if (this.assignmentUnitSelect.value === "Individual") {
                        // Student 1 (Individual) visits the decision point the first time (Inactive)
                        await this.visitDecisionPoint(student1.name, student1.id, null);

                        // Update experiment status to enrolling
                        await this.updateExperimentStatus("enrolling");

                        // Student 1 (Individual) visits the decision point the second time (Enrolling)
                        await this.visitDecisionPoint(student1.name, student1.id, null);

                        // Student 2 (Individual) visits the decision point the first time (Enrolling)
                        await this.visitDecisionPoint(student2.name, student2.id, null);

                        // Student 3 (Individual) visits the decision point the first time (Enrolling)
                        await this.visitDecisionPoint(student3.name, student3.id, null);

                        // Student 4 (Individual) visits the decision point the first time (Enrolling)
                        await this.visitDecisionPoint(student4.name, student4.id, null);

                        // Update experiment status to enrollment complete
                        await this.updateExperimentStatus("enrollmentComplete");

                        // Student 1 (Individual) visits the decision point the third time (Enrollment Complete)
                        await this.visitDecisionPoint(student1.name, student1.id, null);

                        // Student 2 (Individual) visits the decision point the second time (Enrollment Complete)
                        await this.visitDecisionPoint(student2.name, student2.id, null);

                        // Student 3 (Individual) visits the decision point the second time (Enrollment Complete)
                        await this.visitDecisionPoint(student3.name, student3.id, null);

                        // Student 4 (Individual) visits the decision point the second time (Enrollment Complete)
                        await this.visitDecisionPoint(student4.name, student4.id, null);

                        // Student 5 (Individual) visits the decision point the first time (Enrollment Complete)
                        await this.visitDecisionPoint(student5.name, student5.id, null);
                    } else {
                        // Student 1 (Group A) visits the decision point the first time (Inactive)
                        await this.visitDecisionPoint(student1.name, student1.id, "Group A");

                        // Update experiment status to enrolling
                        await this.updateExperimentStatus("enrolling");

                        // Student 1 (Group A) visits the decision point the second time (Enrolling)
                        await this.visitDecisionPoint(student1.name, student1.id, "Group A");

                        // Student 2 (Group A) visits the decision point the first time (Enrolling)
                        await this.visitDecisionPoint(student2.name, student2.id, "Group A");

                        // Student 4 (Group B) visits the decision point the first time (Enrolling)
                        await this.visitDecisionPoint(student4.name, student4.id, "Group B");

                        // Update experiment status to enrollment complete
                        await this.updateExperimentStatus("enrollmentComplete");

                        // Student 1 (Group A) visits the decision point the third time (Enrollment Complete)
                        await this.visitDecisionPoint(student1.name, student1.id, "Group A");

                        // Student 2 (Group A) visits the decision point the second time (Enrollment Complete)
                        await this.visitDecisionPoint(student2.name, student2.id, "Group A");

                        // Student 3 (Group A) visits the decision point the first time (Enrollment Complete)
                        await this.visitDecisionPoint(student3.name, student3.id, "Group A");

                        // Student 4 (Group B) visits the decision point the second time (Enrolling)
                        await this.visitDecisionPoint(student4.name, student4.id, "Group B");

                        // Student 5 (Group B) visits the decision point the first time (Enrolling)
                        await this.visitDecisionPoint(student5.name, student5.id, "Group B");
                    }
                }

                async updateExperimentStatus(experimentStatus) {
                    if (experimentStatus === this.experimentStatus) {
                        return;
                    }
                    await this.fetchWrapper.post(`${this.hostUrlSelect.value}/api/experiments/state`, {
                        experimentId: this.experimentId,
                        state: experimentStatus
                    });
                    this.experimentStatus = experimentStatus;

                    // Delay for a specified number of milliseconds
                    const statusUpdateDelayMillis = Number(this.statusUpdateDelay.value) * 1000
                    await new Promise(resolve => setTimeout(resolve, statusUpdateDelayMillis));
                }

                async visitDecisionPoint(studentName, studentId, group) {
                    const upClient = new UpgradeClient(studentId, this.hostUrlSelect.value, this.appContextSelect.value);
                    const initStartTime = Date.now();
                    await upClient.init();
                    this.responseTimeCellMap.init.responseTimes.push(Date.now() - initStartTime);
                    if (group && this.assignmentUnitSelect.value !== "Individual") {
                        const groupType = this.assignmentUnitSelect.value;
                        const groupMembership = {
                            [groupType]:  ["Group A", "Group B"]
                        }
                        const workingGroup = {
                            [groupType]: group
                        }
                        await upClient.setGroupMembership(groupMembership);
                        await upClient.setWorkingGroup(workingGroup);
                    }
                    const experimentSite = `Site_${this.experimentId}`;
                    const experimentTarget = `Target_${this.experimentId}`;
                    const assignStartTime = Date.now();
                    const assignment = await upClient.getDecisionPointAssignment(experimentSite, experimentTarget);
                    this.responseTimeCellMap.assign.responseTimes.push(Date.now() - assignStartTime);
                    let conditionCode = null;
                    let markStatus = "no condition assigned";
                    if (assignment !== null) {
                        markStatus = "condition applied";
                        conditionCode = assignment.getCondition();
                        if (!this.conditionCodes.includes(conditionCode)) {
                            markStatus = "condition not applied";
                        }
                    }
                    const markStartTime = Date.now();
                    await assignment.markDecisionPoint(markStatus);
                    this.responseTimeCellMap.mark.responseTimes.push(Date.now() - markStartTime);

                    // Update the condition cells
                    if (this.conditionCellMap.hasOwnProperty(studentName)) {
                        const conditionCell = this.conditionCellMap[studentName][this.experimentStatus];
                        conditionCell.innerText = conditionCode === null ? "Default" : conditionCode;
                        conditionCell.style.background = this.conditionCellColorMap[conditionCell.innerText];
                    }
                    // Update the response time cells
                    Object.values(this.responseTimeCellMap).forEach((value) => {
                        const mean = Math.round(value.responseTimes.reduce((a, b) => a + b) / value.responseTimes.length);
                        const max = Math.round(value.responseTimes.reduce((a, b) => Math.max(a, b)));
                        value.cell.innerHTML = `Mean: ${mean}<br>Max: ${max}`;
                        if (max < this.minModerateTime) {
                            value.cell.style.background = this.responseTimeCellColorMap["Fast"];
                        } else if (max < this.minSlowTime) {
                            value.cell.style.background = this.responseTimeCellColorMap["Moderate"];
                        } else {
                            value.cell.style.background = this.responseTimeCellColorMap["Slow"];
                        }
                    });
                }

                // Make data functions (Used by createExperiment())
                makePartition(decisionPoint) {
                    const partition = {
                        createdAt: this.date,
                        updatedAt: this.date,
                        versionNumber: 1,
                        id: decisionPoint.id,
                        twoCharacterId: decisionPoint.twoCharacterId,
                        site: decisionPoint.site,
                        target: decisionPoint.target,
                        description: "",
                        order: 1,
                        excludeIfReached: this.excludeIfReachedSelect.value === "True",
                        ...(this.experimentTypeSelect.value === "Factorial" && { conditionPayloads: [] })
                    };
                    return partition;
                }

                makeCondition(conditionCode, conditionIdMap, payloadIdMap, levelCombinationIdMap, isParentCondition) {
                    const condition = {
                        createdAt: this.date,
                        updatedAt: this.date,
                        versionNumber: 1,
                        id: conditionIdMap[conditionCode].id,
                        twoCharacterId: conditionIdMap[conditionCode].twoCharacterId,
                        name: this.experimentTypeSelect.value === "Simple" ? "" : conditionCode,
                        description: null,
                        conditionCode: conditionCode,
                        assignmentWeight: 100 / this.conditionCodes.length,
                        order: 1,
                        ...(!isParentCondition && this.experimentTypeSelect.value === "Simple" &&
                        {
                            conditionPayloads: [
                                {
                                    createdAt: this.date,
                                    updatedAt: this.date,
                                    versionNumber: 1,
                                    id: payloadIdMap[conditionCode],
                                    payloadValue: conditionCode,
                                    payloadType: "string"
                                }
                            ],
                            levelCombinationElements: []
                        }),
                        ...(this.experimentTypeSelect.value === "Factorial" && { levelCombinationElements: this.makeLevelCombinationElements(conditionCode, levelCombinationIdMap) })
                    }
                    return condition;
                }

                makeLevelCombinationElements(conditionCode, levelCombinationIdMap) {
                    return levelCombinationIdMap[conditionCode].map(levelCombinationElement => ({
                        createdAt: this.date,
                        updatedAt: this.date,
                        versionNumber: 1,
                        id: levelCombinationElement.id,
                        level: {
                            createdAt: this.date,
                            updatedAt: this.date,
                            versionNumber: 1,
                            id: levelCombinationElement.levelId,
                            name: levelCombinationElement.levelName,
                            description: null,
                            payloadValue: "",
                            payloadType: "string",
                            order: null
                        }
                    }));
                }

                makePayloads(decisionPoint, conditionIdMap, payloadIdMap, levelCombinationIdMap, useReference) {
                    const payloads = [];
                    for (const conditionCode of this.conditionCodes) {
                        const payload = {
                            createdAt: this.date,
                            updatedAt: this.date,
                            versionNumber: 1,
                            id: payloadIdMap[conditionCode],
                            parentCondition: useReference ? conditionIdMap[conditionCode].id : this.makeCondition(conditionCode, conditionIdMap, payloadIdMap, levelCombinationIdMap, true),
                            ...(this.experimentTypeSelect.value === "Simple" && { decisionPoint: useReference ? decisionPoint.id : this.makePartition(decisionPoint) }),
                            payload: {
                                type: "string",
                                value: conditionCode
                            }
                        }
                        payloads.push(payload);
                    }
                    return payloads;
                }

                makeFactors(conditionCodes, levelIdMap) {
                    // Build array of factors [{name, levelNames}, ...]
                    const factors = conditionCodes.reduce((acc, str) => {
                        str.split("; ").forEach(factor => {
                            const [name, levelName] = factor.split("=");
                            const existingFactor = acc.find(f => f.name === name);
                            if (existingFactor) {
                                if (!existingFactor.levelNames.includes(levelName)) {
                                    existingFactor.levelNames.push(levelName);
                                }
                            } else {
                                acc.push({ name, levelNames: [levelName] });
                            }
                        });
                        return acc;
                    }, []);

                    return factors.map(factor => ({
                        id: this.idGenerator.uuidv4(),
                        name: factor.name,
                        order: 1,
                        description: "",
                        levels: factor.levelNames.map(levelName => ({
                            createdAt: this.date,
                            updatedAt: this.date,
                            versionNumber: 1,
                            id: levelIdMap[levelName],
                            name: levelName,
                            description: "",
                            order: null,
                            payload: {
                                type: "string",
                                value: ""
                            }
                        }))
                    }));
                }

                makeQueries() {
                    const queries = [];
                    for (const queryKey of this.queryKeys) {
                        const query = {
                            createdAt: this.date,
                            updatedAt: this.date,
                            versionNumber: 1,
                            id: this.idGenerator.uuidv4(),
                            name: `${queryKey} (Mean)`,
                            query: {
                                operationType: "avg"
                            },
                            repeatedMeasure: "MOST RECENT",
                            metric: {
                                createdAt: this.date,
                                updatedAt: this.date,
                                versionNumber: 1,
                                key: queryKey,
                                type: "continuous",
                                allowedData: null
                            }
                        }
                        queries.push(query);
                    }
                    return queries;
                }

                makeExperimentSegment(segmentNamePrefix, type) {
                    const name = `${segmentNamePrefix} ${type} Segment`;
                    const groupForSegment = [];
                    if (type === "Inclusion") {
                        groupForSegment.push(
                            {
                                createdAt: this.date,
                                updatedAt: this.date,
                                versionNumber: 1,
                                groupId: "All",
                                type: "All"
                            }
                        );
                    }

                    return {
                        createdAt: this.date,
                        updatedAt: this.date,
                        versionNumber: 1,
                        segment: {
                            createdAt: this.date,
                            updatedAt: this.date,
                            versionNumber: 1,
                            id: this.idGenerator.uuidv4(),
                            name: name,
                            description: name,
                            context: this.appContextSelect.value,
                            type: "private",
                            individualForSegment: [],
                            groupForSegment: groupForSegment,
                            subSegments: []
                        }
                    }
                }
            }

            class FetchWrapper {
                get headers() {
                    return {
                        "Accept": "application/json",
                        "Content-Type": "application/json",
                        ...(token && { "Authorization": `Bearer ${token}` })
                    };
                }

                async getData(response) {
                    const data = await response.json();
                    if (data.error) {
                        throw data.error;
                    }
                    return data;
                }

                async fetchGetDelete(url, method) {
                    const response = await fetch(url, {
                        method,
                        headers: this.headers
                    });
                    return await this.getData(response);
                }

                async fetchPostPut(url, method, data = {}) {
                    const response = await fetch(url, {
                        method,
                        headers: this.headers,
                        body: JSON.stringify(data)
                    });
                    return await this.getData(response);
                }

                async get(url) {
                    return await this.fetchGetDelete(url, "GET");
                }

                async post(url, data) {
                    return await this.fetchPostPut(url, "POST", data);
                }

                async put(url, data) {
                    return await this.fetchPostPut(url, "PUT", data);
                }

                async delete(url) {
                    return await this.fetchGetDelete(url, "DELETE");
                }
            }

            class IdGenerator {
                constructor() {
                    this.twoCharacterIdSet = new Set();
                    this.numCombinations = 36 * 36;
                }

                reset() {
                    this.twoCharacterIdSet.clear();
                }

                twoCharacterId() { // Note: UpGrade's twoCharacterId() function should be updated like this to prevent freezing
                    while (this.twoCharacterIdSet.size < this.numCombinations) {
                        const id = Math.random().toString(36).substring(2, 4).toUpperCase();
                        if (!this.twoCharacterIdSet.has(id)) {
                            this.twoCharacterIdSet.add(id);
                            return id;
                        }
                    }
                    throw new Error("twoCharacterId exceeded the limit");
                }

                uuidv4() {
                    return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                    );
                }
            }
        })();
    </script>
</body>

</html>